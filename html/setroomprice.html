<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.amber-orange.min.css" />
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/material-dashboard.css" rel="stylesheet" />
    <!--<link href="../css/material-kit.css" rel="stylesheet" />-->
    <!--     Fonts and icons     -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300|Material+Icons' rel='stylesheet' type='text/css'>
    <link href="../css/manager_template.css" rel="stylesheet" />
    <link href="../css/checkbox.css" rel="stylesheet" />
    <link href="../css/fullcalendar.css" rel="stylesheet" />
    <!--<link href="../css/_materialFullCalendar.css" rel="stylesheet" />-->
    <link href="../css/sweetalert2.css" rel="stylesheet" />
    <title></title>
    <style>
        #calendar {
            /* 		float: right; */
            margin: 0 auto;
            padding: 15px;
            width: 80%; 
            background-color: #FFFFFF;
            border-radius: 6px;
            /*box-shadow: 0 1px 2px #C3C3C3;*/
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!--側邊導覽列-->
        <div class="sidebar" data-color="orange">
            <div class="logo">
                <a href="http://www.creative-tim.com" class="simple-text">
                    <img alt="Brand" height="30" src="../img/logo.png" />
                </a>
            </div>

            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li>
                        <a href="dashboard.html">
                            <i class="material-icons">dashboard</i>
                            <p>總攬</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">location_city</i>
                            <p>飯店資料</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">picture_in_picture_alt</i>
                            <p>編輯飯店圖片</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">add_circle_outline</i>
                            <p>編輯飯店房型</p>
                        </a>
                    </li>
                    <li class="active">
                        <a href="#">
                            <i class="material-icons">attach_money</i>
                            <p>設定每日房型價錢</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">bookmark_border</i>
                            <p>查詢訂單紀錄</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">comment</i>
                            <p>查詢評論</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!--側邊導覽列結束-->
        <!--右側大畫布-->
        <div class="main-panel">
            <!--上方導覽列-->
            <nav class="navbar navbar-transparent navbar-absolute">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#">飯店管理中心</a>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <!--home-->
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">dashboard</i>
                                    <p class="hidden-lg hidden-md">Dashboard</p>
                                </a>
                            </li>
                            <!--home-->
                            <!--dropdown-->
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">notifications</i>
                                    <span class="notification">5</span>
                                    <p class="hidden-lg hidden-md">Notifications</p>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="#">Mike John responded to your email</a>
                                    </li>
                                    <li>
                                        <a href="#">You have 5 new tasks</a>
                                    </li>
                                    <li>
                                        <a href="#">You're now friend with Andrew</a>
                                    </li>
                                    <li>
                                        <a href="#">Another Notification</a>
                                    </li>
                                    <li>
                                        <a href="#">Another One</a>
                                    </li>
                                </ul>
                            </li>
                            <!--dropdown-->
                        </ul>
                    </div>
                </div>
            </nav>
            <!--上方導覽列-->
            <!--內容區塊-->
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-content">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="select">
                                                <select style="margin-top:15px;">
                                                    <option selected>請選擇房型</option>
                                                    <option value="1">雅緻雙人房（無窗）</option>
                                                    <option value="2">標準雙人房</option>
                                                    <option value="3">豪華家庭房</option>
                                                    <option value="4">家庭房 - 無窗</option>
                                                </select>
                                                <div class="select__arrow" style="margin-top:15px;"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-7">
                                            <div id="radio">
                                                <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="weekdaysPrice">
                                                    <input type="radio" id="weekdaysPrice" class="mdl-radio__button" name="price" value="1">
                                                    <span class="mdl-radio__label">平日價</span>
                                                </label>
                                                <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="holidayPrice">
                                                    <input type="radio" id="holidayPrice" class="mdl-radio__button" name="price" value="1">
                                                    <span class="mdl-radio__label">假日價</span>
                                                </label>
                                                <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="seasonPrice">
                                                    <input type="radio" id="seasonPrice" class="mdl-radio__button" name="price" value="1">
                                                    <span class="mdl-radio__label">旺季價</span>
                                                </label>
                                                <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="customizedPrice">
                                                    <input type="radio" id="customizedPrice" class="mdl-radio__button" name="price" value="1">
                                                    <span class="mdl-radio__label">情侶甜蜜價</span>
                                                </label>
                                            </div>
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" name="weekday" value="0">
                                                    星期日
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday"
                                                           value="1"> 星期一
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday"
                                                           value="2"> 星期二
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday" value="3">
                                                    星期三
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday" value="4">
                                                    星期四
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday" value="5">
                                                    星期五
                                                </label>
                                                <label>
                                                    <input type="checkbox" name="weekday" value="6">
                                                    星期六
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-info" id="plus">+</button>
                                            <button class="btn btn-info" id="submit">確認送出</button>
                                            <button class="btn btn-info" id="showJson">showJson</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-content">
                                    <div class="col-md-12">
                                        <div id="calendar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel"></h4>
                            </div>
                            <div class="modal-body">
                                <h3>請選擇價錢</h3>
                                <div id="price-select"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default btn-simple" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-info btn-simple" id="submit-single">修改</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--內容區塊-->
            <!--footer-->
            <footer class="footer">
                <div class="container-fluid">
                    <p class="copyright pull-right">
                        <small>版權所有©2005 – 2017, iCastle Company Pte. Ltd.保留所有權利</small>
                        <a href="http://www.creative-tim.com">
                            <img alt="Brand" width="130" src="../img/logo.png" />
                        </a>
                    </p>
                </div>
            </footer>
            <!--footer-->
        </div>
        <!--右側大畫布-->





    </div>


</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/material.min.js"></script>

<script src="../js/chartist.min.js"></script>

<script src="../js/bootstrap-notify.js"></script>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>

<script src="../js/material-dashboard.js"></script>
<script src="../js/material-kit.js"></script>
<script src="../js/moment.min.js"></script>
<script src="../js/fullcalendar.js"></script>
<script src="../js/sweetalert2.min.js"></script>
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<script>
    $(function () {
        $('.modal').appendTo("body");
        //選擇房型後更新日曆
        $('select').change(function () {
            var events = {
                url: '${pageContext.servletContext.contextPath}/json/rooms/MonthRoomsToJson',
                data: {
                    hotelId: '${HotelLoginOK.hotelId}',
                    roomTypeId: $('select').val(),
                }
            }

            // 			$('#calendar').fullCalendar( 'removeEventSource', events);
            $('#calendar').fullCalendar('removeEventSources');
            $('#calendar').fullCalendar('addEventSource', events);
            $('#calendar').fullCalendar('refetchEvents');

            genPriceSelect('#radio', 'price');
            json.length = 0;

        })

        //生成價錢選擇器
        function genPriceSelect(selector, inputName) {
            $.getJSON("${pageContext.servletContext.contextPath}/json/roomtype/RoomTypePriceToJson", { "roomTypeId": $('select').val() },
                function (data) {
                    var checkbox_div = $(selector);
                    checkbox_div.empty();
                    $.each(data, function (i, price) {
                        var label_weekdaysPrice = $('<label></label>').addClass("mdl-radio mdl-js-radio mdl-js-ripple-effect").attr("for", "weekdaysPrice");
                        var input_weekdaysPrice = $('<input/>').attr({ type: "radio", value: price.weekdaysPrice, name: inputName, id: "weekdaysPrice" });
                        var span_weekdaysPrice = $('<span></span>').addClass("mdl-radio__label").text("平日價");
                        label_weekdaysPrice.append([input_weekdaysPrice, span_weekdaysPrice]);

                        var label_holidayPrice = $('<label></label').addClass("mdl-radio mdl-js-radio mdl-js-ripple-effect").attr("for", "holidayPrice");
                        var input_holidayPrice = $('<input/>').attr({ type: "radio", value: price.holidayPrice, name: inputName, id: "holidayPrice" });
                        var span_holidayPrice = $('<span></span>').addClass("mdl-radio__label").text("假日價");
                        label_holidayPrice.append([input_holidayPrice, span_holidayPrice]);

                        var label_seasonPrice = $('<label></label').addClass("mdl-radio mdl-js-radio mdl-js-ripple-effect").attr("for", "seasonPrice");
                        var input_seasonPrice = $('<input/>').attr({ type: "radio", value: price.seasonPrice, name: inputName, id: "seasonPrice" });
                        var span_seasonPrice = $('<span></span>').addClass("mdl-radio__label").text("旺季價");
                        label_seasonPrice.append([input_seasonPrice, span_seasonPrice]);

                        var label_customizedPrice = $('<label></label').addClass("mdl-radio mdl-js-radio mdl-js-ripple-effect").attr("for", price.customizedName);
                        var input_customizedPrice = $('<input/>').attr({ type: "radio", value: price.customizedPrice, name: inputName, id: price.customizedName });
                        var span_customizedPrice = $('<span></span>').addClass("mdl-radio__label").text(price.customizedName);
                        label_customizedPrice.append(input_customizedPrice);
                        checkbox_div.append([label_weekdaysPrice, label_holidayPrice, label_seasonPrice, label_customizedPrice]);
                    })

                })
        }

        //初始化fullCalendar，並註冊dayClick及eventClick事件
        $('#calendar').fullCalendar({
            header: {
                left: 'title',
                right: 'prev,next today'
            },
            eventSources: [{
                url: '${pageContext.servletContext.contextPath}/json/rooms/MonthRoomsToJson',
                data: {
                    hotelId: '${HotelLoginOK.hotelId}',
                    roomTypeId: $('select').val(),
                },
                error: function () {
                    swal({
                        title: '請先選擇房型',
                        type: 'info',
                    })
                }
            }],
            dayClick: function (date, jsEvent, view) {
                $('#myModalLabel').text(moment(date).format('YYYY-MM-DD'));
                genPriceSelect('#price-select', 'priceBySingle');
                $('#myModal').modal('show');
            },
            eventClick: function (calEvent, jsEvent, view) {
                $('#myModalLabel').text(calEvent.start._i);
                genPriceSelect('#price-select', 'priceBySingle');
                $('#myModal').modal('show');
            }
        })

        $('#plus').click(function (e) {
            add()
        })

        //存放使用者勾選的星期
        var weekdaycheck = [];
        //存放新增或修改價錢的json資料
        var json = [];

        //註冊勾選星期事件
        $('input[name=weekday]').click(function () {
            var weekdayNum = ($(this).prop("checked")) ? $(this).val() : null;
            if (weekdaycheck.length > 0 && weekdayNum != null) {
                for (var i = 0; i < weekdaycheck.length; i++) {
                    if (weekdaycheck[i] == parseInt(weekdayNum)) {
                        delete weekdaycheck[i];
                    }
                }
            } else if (weekdayNum == null) {
                for (var i = 0; i < weekdaycheck.length; i++) {
                    if (weekdaycheck[i] == parseInt($(this).val())) {
                        delete weekdaycheck[i];
                    }
                }
            }
            weekdaycheck.push(parseInt(weekdayNum));
        });

        $('#showJson').click(function () {
            alert(JSON.stringify(json))
        })

        //新增日期事件
        function add() {
            $('#calendar')
                .fullCalendar(
                'addEventSource',
                function (start, end, timezone, callback) {
                    var events = [];
                    var startd = new Date(start);
                    var endd = new Date(end);
                    var end = endd.getTime();
                    var price = $('input[name=price]:checked').val();

                    //判斷是否有勾選星期及價錢
                    if (weekdaycheck.length > 0 && !(price == null)) {
                        //根據目前月分跑每日迴圈
                        for (var loop = startd.getTime(); loop <= end; loop += (24 * 60 * 60 * 1000)) {
                            var date = new Date(loop);
                            var eventoObj = $("#calendar").fullCalendar('clientEvents', moment(date).format('YYYY-MM-DD'))[0];
                            //抓取weekdaycheck陣列的值
                            for (var i = 0; i < weekdaycheck.length; i++) {
                                //判斷現在日期星期是否與使用捨勾選的相同及該日期是否有已存在的價錢
                                if (date.getDay() == weekdaycheck[i] && eventoObj == null) {
                                    //新增事件
                                    events.push({
                                        id: moment(date).format('YYYY-MM-DD'),
                                        title: price,
                                        start: moment(date).format('YYYY-MM-DD'),
                                        color: 'lightgreen',
                                        allDay: 'true',
                                        className: 'success',
                                    });
                                    //將新增事件的資料儲存至json準備新增
                                    json.push({
                                        date: moment(date).format('YYYY-MM-DD'),
                                        price: $('input[name=price]:checked').val(),
                                    });
                                    //如果該日期是已有存在的價錢，則更新原有價錢
                                } else if (date.getDay() == weekdaycheck[i]) {
                                    eventoObj.title = price;
                                    eventoObj.color = 'lightgreen';
                                    $('#calendar').fullCalendar('updateEvent', eventoObj);
                                    json.push({
                                        roomId: eventoObj.roomId,
                                        date: moment(date).format('YYYY-MM-DD'),
                                        price: $('input[name=price]:checked').val(),
                                    });
                                }
                            }
                        }
                    } else {
                        swal({
                            title: '請先選擇價錢及星期',
                            type: 'error',
                        })
                    }
                    weekdaycheck.length = 0;
                    $('input[name=weekday]').removeAttr("checked");
                    callback(events);
                })
        }

        //註冊單一更改價錢事件
        $('#submit-single').click(function () {
            var date = $('#myModalLabel').text();
            var price = $('input[name=priceBySingle]:checked').val()
            var eventoObj = $("#calendar").fullCalendar('clientEvents', date)[0];
            if (eventoObj != null) {
                eventoObj.title = price;
                eventoObj.color = 'lightgreen';
                $('#myModal').modal('hide');
                $('#calendar').fullCalendar('updateEvent', eventoObj);
                json.push({
                    roomId: eventoObj.roomId,
                    date: date,
                    price: price,
                });
            } else {
                $("#calendar").fullCalendar('addEventSource',
                    function (start, end, timezone, callback) {
                        var events = [];
                        events.push({
                            id: $('#myModalLabel').text(),
                            title: price,
                            start: moment(date).format('YYYY-MM-DD'),
                            color: 'lightgreen',
                            allDay: 'true',
                        });
                        //將新增事件的資料儲存至json準備新增
                        json.push({
                            date: moment(date).format('YYYY-MM-DD'),
                            price: price,
                        });
                        $('#myModal').modal('hide');
                        callback(events);
                    })
            }

        });

        //將暫存於json內的資料傳送至server新增到資料庫，並重新整理頁面
        $('#submit').click(function () {
            $.ajax({
                type: 'POST',
                url: '${pageContext.servletContext.contextPath}/json/rooms/SetRoomPrice',
                data: {
                    jsonData: JSON.stringify(json),
                    roomTypeId: $('select').val(),
                },
                success: function () {
                    swal({
                        title: '新增成功',
                        type: 'success',
                    })
                }
            })
            json.length = 0;
            var events = {
                url: '${pageContext.servletContext.contextPath}/json/rooms/MonthRoomsToJson',
                data: {
                    hotelId: '${HotelLoginOK.hotelId}',
                    roomTypeId: $('select').val(),
                }
            }

            //	 			$('#calendar').fullCalendar( 'removeEventSource', events);
            $('#calendar').fullCalendar('removeEventSources');
            $('#calendar').fullCalendar('addEventSource', events);
            $('#calendar').fullCalendar('refetchEvents');
        })

    });
</script>



</html>